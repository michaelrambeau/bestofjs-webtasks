# bestof.js.org webtasks

node.js micro-services used by [bestof.js.org](http://bestof.js.org/#/) web application, built using https://webtask.io service.

Each "webtask" is either a plain JavaScript function either or a basic Express web server deployed on webtask.io.

[![Build Status](https://travis-ci.org/michaelrambeau/bestofjs-webtasks.svg?branch=master)](https://travis-ci.org/michaelrambeau/bestofjs-webtasks)

## webtask #1: `user-content-api`

`user-content-api` webtask is an Express web server used to read and write content generated by users:

* Github project **reviews** (user's rating and opinion about projects)
* Github project **links** (resources related to projects: tutorials, blog entries...)

### File system

* `src/server.js`: local Express web server
* `src/webtask.js`: entry point to build the file deployed to webtask.io using Webpack
* `build/webtask.js`: bundled webtask built by Webpack, ignored by git

### URLs

* GET `/reviews/`
* POST `/reviews/`
* PUT `/reviews/:id`


* GET `/links/`
* POST `/links/`
* PUT `/links/:id`

### Local web server

Start the local Express web server on port default port

```
npm start
```

or, using an other port:

```
npm start -- --port 3333
```

### Tests

Tests use [supertest](https://github.com/visionmedia/supertest) module to check Express server reponses without making http requests (no need to open any port).

```
npm test
```

### Deploy on webtask.io

STEP 1: build a single file from source files, using Webpack

```
npm run build
```

STEP 2: Create / Update the webtask, using `wt-cli` command line tool.

For development:

```
npm run deploy
```

For production:

```
npm run deploy-prod
```

Deploy commands will display the webtask URL, when the deploy is completed.

* dev: `https://webtask.it.auth0.com/api/run/wt-mikeair-gmail_com-0/user-content-api-dev`
* production: `https://webtask.it.auth0.com/api/run/wt-mikeair-gmail_com-0/user-content-api-v1`

## Environment variables

In local, environment variables are defined in the `.env` file.

* MONGO_URI: mongodb URL, database used to store reviews and links
* MONGO_URI_TEST: mongodb URL, database used for tests only (its content is automatically deleted by `setup` command)
* AUTH0_API_TOKEN: token used to authenticate POST and PUT requests

webtask deploy script `user-content-api/deploy-webtask.js` automatically passes `MONGO_URI` and `AUTH0_API_TOKEN` variables, using the `--secret` parameter.
